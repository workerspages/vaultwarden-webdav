<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaultwarden 管理面板</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background: linear-gradient(180deg, #f0f4f8 0%, #e2e8f0 100%); min-height: 100vh; margin: 0; }
        
        /* 标题渐变色 */
        .title-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* 登录页 */
        .login-container { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(135deg, #0f172a 0%, #1e40af 50%, #3b82f6 100%); 
        }
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* 卡片样式 */
        .card-modern {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .card-modern:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }
        .card-header-gradient {
            padding: 16px 20px;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-body { padding: 20px; }
        
        /* 动画 */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* 折叠面板样式 */
        .el-collapse { border: none; }
        .el-collapse-item__header { 
            font-weight: 600; 
            color: #334155;
            padding: 12px 0;
            font-size: 14px;
        }
        .el-collapse-item__wrap { border: none; }
        .el-collapse-item__content { padding: 16px 0; }
        
        /* 按钮样式增强 */
        .btn-gradient-primary {
            background: var(--primary-gradient);
            border: none;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-gradient-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-gradient-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            border: none;
            color: white;
            font-weight: 600;
        }
        .btn-gradient-success {
            background: var(--success-gradient);
            border: none;
            color: white;
            font-weight: 600;
        }
        
        /* 日志区域 */
        .log-container {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
            border-radius: 12px;
            padding: 16px;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #22c55e;
            height: 280px;
            overflow-y: auto;
        }
        .log-container::-webkit-scrollbar { width: 6px; }
        .log-container::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        
        /* 备份列表 */
        .backup-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }
        .backup-item:hover { background: #f8fafc; }
        .backup-item:last-child { border-bottom: none; }
        
        /* 头部导航 */
        .header-bar {
            background: white;
            padding: 16px 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-icon {
            background: var(--primary-gradient);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        
        /* 响应式 */
        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 登录界面 -->
        <div v-if="!isLoggedIn" class="login-container">
            <el-card class="w-96 login-card shadow-2xl rounded-2xl border-none">
                <template #header>
                    <div class="text-center py-2">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-2xl flex items-center justify-center text-white font-bold text-xl" style="background: var(--primary-gradient)">VW</div>
                        <h2 class="text-2xl font-bold text-gray-800">系统登录</h2>
                        <p class="text-gray-500 text-sm mt-2">Vaultwarden Backup Admin</p>
                    </div>
                </template>
                <el-form label-position="top" size="large" @submit.prevent="login">
                    <el-form-item label="用户名">
                        <el-input v-model="loginForm.username" prefix-icon="User" placeholder="请输入用户名"></el-input>
                    </el-form-item>
                    <el-form-item label="密码">
                        <el-input v-model="loginForm.password" type="password" prefix-icon="Lock" show-password placeholder="请输入密码"></el-input>
                    </el-form-item>
                    <el-button class="w-full mt-4 h-12 btn-gradient-primary" @click="login" :loading="loginLoading">
                        <span class="text-base">登 录</span>
                    </el-button>
                </el-form>
            </el-card>
        </div>

        <!-- 主面板界面 -->
        <div v-else class="fade-in">
            <!-- 顶部导航 -->
            <header class="header-bar">
                <div class="logo-section">
                    <div class="logo-icon">VW</div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800 leading-tight">Vaultwarden <span class="title-gradient">Admin</span></h1>
                        <p class="text-xs text-gray-400">备份管理控制台</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <el-tag type="success" round size="small">
                        <el-icon class="mr-1"><CircleCheck /></el-icon>运行中
                    </el-tag>
                    <el-button type="danger" plain size="small" @click="logout" icon="SwitchButton">退出</el-button>
                </div>
            </header>

            <!-- 主内容区 三栏布局 -->
            <div class="p-6 max-w-7xl mx-auto">
                <div class="main-grid grid grid-cols-1 lg:grid-cols-12 gap-6">
                    
                    <!-- 左侧：操作 + 备份列表 -->
                    <div class="lg:col-span-3 space-y-6">
                        <!-- 快捷操作 -->
                        <div class="card-modern">
                            <div class="card-header-gradient" style="background: var(--primary-gradient)">
                                <el-icon><Promotion /></el-icon>
                                <span>快捷操作</span>
                            </div>
                            <div class="card-body space-y-3">
                                <el-button class="w-full h-11 btn-gradient-primary" @click="backupNow" :loading="loading" icon="UploadFilled">
                                    立即备份到云端
                                </el-button>
                                <el-upload 
                                    class="w-full"
                                    action="/api/upload_restore" 
                                    :headers="authHeaders" 
                                    :on-success="handleUploadSuccess" 
                                    :on-error="handleUploadError" 
                                    :show-file-list="false" 
                                    accept=".zip">
                                    <el-button class="w-full h-11 btn-gradient-warning" icon="Upload">上传 Zip 还原</el-button>
                                </el-upload>
                                <p class="text-xs text-gray-400 text-center pt-1">支持加密 zip 文件自动解密</p>
                            </div>
                        </div>

                        <!-- 云端备份列表 -->
                        <div class="card-modern">
                            <div class="card-header-gradient" style="background: var(--info-gradient)">
                                <el-icon><FolderOpened /></el-icon>
                                <span>云端备份 ({{ backups.length }})</span>
                                <el-button class="ml-auto" size="small" circle @click="loadBackups" icon="Refresh" style="background: rgba(255,255,255,0.2); border: none; color: white;"></el-button>
                            </div>
                            <div class="max-h-80 overflow-y-auto">
                                <div v-if="backups.length === 0" class="p-8 text-center text-gray-400">
                                    <el-icon size="40" class="mb-2"><Folder /></el-icon>
                                    <p>暂无备份</p>
                                </div>
                                <div v-for="backup in backups" :key="backup.name" class="backup-item">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-gray-700 truncate">{{ backup.name }}</p>
                                        <p class="text-xs text-gray-400">{{ backup.last_modified }}</p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs bg-gray-100 px-2 py-1 rounded">{{ backup.size }}</span>
                                        <el-popconfirm title="确定还原此备份？服务将重启" width="200" @confirm="restore(backup.name)">
                                            <template #reference>
                                                <el-button size="small" type="danger" circle icon="Download"></el-button>
                                            </template>
                                        </el-popconfirm>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 中间：配置区（折叠面板） -->
                    <div class="lg:col-span-5">
                        <div class="card-modern">
                            <div class="card-header-gradient" style="background: var(--success-gradient)">
                                <el-icon><Setting /></el-icon>
                                <span>系统配置</span>
                            </div>
                            <div class="card-body">
                                <el-collapse v-model="activeCollapse">
                                    <!-- WebDAV 配置 -->
                                    <el-collapse-item name="webdav">
                                        <template #title>
                                            <el-icon class="mr-2"><Link /></el-icon> WebDAV 连接
                                        </template>
                                        <el-form label-position="top" size="default">
                                            <el-form-item label="服务器地址">
                                                <el-input v-model="config.webdav_url" placeholder="https://dav.example.com/"></el-input>
                                            </el-form-item>
                                            <div class="grid grid-cols-2 gap-4">
                                                <el-form-item label="用户名">
                                                    <el-input v-model="config.webdav_user"></el-input>
                                                </el-form-item>
                                                <el-form-item label="密码">
                                                    <el-input type="password" v-model="config.webdav_password" show-password></el-input>
                                                </el-form-item>
                                            </div>
                                            <el-form-item label="存储路径">
                                                <el-input v-model="config.webdav_path" placeholder="/vaultwarden-backups"></el-input>
                                            </el-form-item>
                                        </el-form>
                                    </el-collapse-item>

                                    <!-- 备份策略 -->
                                    <el-collapse-item name="schedule">
                                        <template #title>
                                            <el-icon class="mr-2"><Timer /></el-icon> 备份策略
                                        </template>
                                        <el-form label-position="top" size="default">
                                            <el-form-item>
                                                <template #label>
                                                    <span>Cron 表达式</span>
                                                    <el-tooltip content="例如: '0 3 * * *' 表示每天凌晨3点" placement="top">
                                                        <el-icon class="ml-1 text-gray-400"><QuestionFilled /></el-icon>
                                                    </el-tooltip>
                                                </template>
                                                <el-input v-model="config.schedule_cron" placeholder="0 3 * * *"></el-input>
                                                <a href="https://crontab.guru/" target="_blank" class="text-xs text-blue-500 mt-1 block hover:underline">Cron 表达式生成助手 →</a>
                                            </el-form-item>
                                            <el-form-item>
                                                <template #label>
                                                    <span>最大保留数量</span>
                                                    <el-tooltip content="云端只保留最新的N份备份" placement="top">
                                                        <el-icon class="ml-1 text-gray-400"><QuestionFilled /></el-icon>
                                                    </el-tooltip>
                                                </template>
                                                <el-input-number v-model="config.max_backups" :min="1" :max="999" class="w-full"></el-input-number>
                                            </el-form-item>
                                        </el-form>
                                    </el-collapse-item>

                                    <!-- 安全设置 -->
                                    <el-collapse-item name="security">
                                        <template #title>
                                            <el-icon class="mr-2"><Lock /></el-icon> 安全设置
                                        </template>
                                        <el-form label-position="top" size="default">
                                            <el-form-item label="备份加密密码">
                                                <el-input type="password" v-model="config.encryption_password" show-password placeholder="留空则不加密"></el-input>
                                                <p class="text-xs text-gray-400 mt-1">设置后将使用 AES-256 加密 Zip 文件</p>
                                            </el-form-item>
                                        </el-form>
                                    </el-collapse-item>

                                    <!-- Telegram 通知 -->
                                    <el-collapse-item name="telegram">
                                        <template #title>
                                            <el-icon class="mr-2"><ChatDotRound /></el-icon> Telegram 通知
                                        </template>
                                        <el-form label-position="top" size="default">
                                            <div class="grid grid-cols-2 gap-4">
                                                <el-form-item label="Bot Token">
                                                    <el-input v-model="config.tg_bot_token" placeholder="123456:ABC-DEF..."></el-input>
                                                </el-form-item>
                                                <el-form-item label="Chat ID">
                                                    <el-input v-model="config.tg_chat_id" placeholder="-100xxxxxx"></el-input>
                                                </el-form-item>
                                            </div>
                                        </el-form>
                                    </el-collapse-item>

                                    <!-- Bark 通知 (iOS) -->
                                    <el-collapse-item name="bark">
                                        <template #title>
                                            <el-icon class="mr-2"><Iphone /></el-icon> Bark 通知 (iOS)
                                        </template>
                                        <el-form label-position="top" size="default">
                                            <el-form-item label="Bark 推送地址">
                                                <el-input v-model="config.bark_url" placeholder="https://api.day.app/xxxxxxxx"></el-input>
                                                <p class="text-xs text-gray-400 mt-1">在 Bark App 中复制推送地址</p>
                                            </el-form-item>
                                        </el-form>
                                    </el-collapse-item>

                                    <!-- 邮件通知 -->
                                    <el-collapse-item name="email">
                                        <template #title>
                                            <el-icon class="mr-2"><Message /></el-icon> 邮件通知
                                        </template>
                                        <el-form label-position="top" size="default">
                                            <div class="grid grid-cols-2 gap-4">
                                                <el-form-item label="SMTP 服务器">
                                                    <el-input v-model="config.smtp_host" placeholder="smtp.example.com"></el-input>
                                                </el-form-item>
                                                <el-form-item label="端口">
                                                    <el-input-number v-model="config.smtp_port" :min="1" :max="65535" class="w-full" placeholder="465"></el-input-number>
                                                </el-form-item>
                                            </div>
                                            <div class="grid grid-cols-2 gap-4">
                                                <el-form-item label="SMTP 用户名">
                                                    <el-input v-model="config.smtp_user" placeholder="user@example.com"></el-input>
                                                </el-form-item>
                                                <el-form-item label="SMTP 密码">
                                                    <el-input type="password" v-model="config.smtp_pass" show-password placeholder="授权码或密码"></el-input>
                                                </el-form-item>
                                            </div>
                                            <el-form-item label="收件邮箱">
                                                <el-input v-model="config.mail_to" placeholder="notify@example.com"></el-input>
                                            </el-form-item>
                                        </el-form>
                                    </el-collapse-item>
                                </el-collapse>

                                <el-button class="w-full mt-6 h-11 btn-gradient-success" @click="saveConfig" icon="Check">
                                    保存所有配置
                                </el-button>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：日志 -->
                    <div class="lg:col-span-4">
                        <div class="card-modern h-full">
                            <div class="card-header-gradient" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%)">
                                <el-icon><Document /></el-icon>
                                <span>实时日志</span>
                                <el-button class="ml-auto" size="small" link @click="loadLogs" style="color: rgba(255,255,255,0.8)">
                                    <el-icon class="mr-1"><Refresh /></el-icon>刷新
                                </el-button>
                            </div>
                            <div class="card-body">
                                <pre class="log-container">{{ logs }}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        const app = createApp({
            setup() {
                const isLoggedIn = ref(false);
                const loginLoading = ref(false);
                const loginForm = ref({ username: '', password: '' });
                const config = ref({ 
                    schedule_cron: '0 3 * * *', 
                    max_backups: 10,
                    webdav_path: '/' 
                });
                const backups = ref([]);
                const logs = ref('等待日志...');
                const loading = ref(false);
                const activeCollapse = ref(['webdav']);

                const authHeaders = computed(() => {
                    const token = localStorage.getItem('vw_auth_token');
                    return token ? { 'Authorization': `Basic ${token}` } : {};
                });

                axios.interceptors.request.use(cfg => {
                    const token = localStorage.getItem('vw_auth_token');
                    if (token) {
                        cfg.headers.Authorization = `Basic ${token}`;
                    }
                    return cfg;
                }, error => Promise.reject(error));

                axios.interceptors.response.use(res => res, err => {
                    if (err.response && err.response.status === 401) {
                        logout();
                        ElementPlus.ElMessage.error('登录已失效，请重新登录');
                    }
                    return Promise.reject(err);
                });

                const login = async () => {
                    if(!loginForm.value.username || !loginForm.value.password) return;
                    loginLoading.value = true;
                    const token = btoa(`${loginForm.value.username}:${loginForm.value.password}`);
                    localStorage.setItem('vw_auth_token', token);
                    
                    try {
                        await axios.get('/api/auth_check');
                        isLoggedIn.value = true;
                        ElementPlus.ElMessage.success('欢迎回来');
                        initData();
                    } catch (e) {
                        localStorage.removeItem('vw_auth_token');
                        ElementPlus.ElMessage.error('用户名或密码错误');
                    } finally {
                        loginLoading.value = false;
                    }
                };

                const logout = () => {
                    localStorage.removeItem('vw_auth_token');
                    isLoggedIn.value = false;
                    loginForm.value = { username: '', password: '' };
                };

                const initData = async () => {
                    await loadConfig();
                    loadLogs();
                    setInterval(loadLogs, 10000);
                };

                const loadConfig = async () => {
                    try {
                        const res = await axios.get('/api/config');
                        if(Object.keys(res.data).length > 0) {
                            config.value = { ...config.value, ...res.data };
                            if(!config.value.schedule_cron) config.value.schedule_cron = '0 3 * * *';
                            if(!config.value.max_backups) config.value.max_backups = 10;
                        }
                        if(config.value.webdav_url) loadBackups();
                    } catch(e) {}
                };

                const saveConfig = async () => {
                    try {
                        await axios.post('/api/config', config.value);
                        ElementPlus.ElMessage.success('配置保存成功');
                    } catch(e) {
                        ElementPlus.ElMessage.error('保存失败');
                    }
                };

                const backupNow = async () => {
                    loading.value = true;
                    try {
                        await axios.post('/api/backup/now');
                        ElementPlus.ElMessage.success('后台备份任务已启动');
                        setTimeout(loadLogs, 1000);
                    } catch(e) {
                        ElementPlus.ElMessage.error('触发失败');
                    } finally {
                        loading.value = false;
                    }
                };

                const loadBackups = async () => {
                    try {
                        const res = await axios.get('/api/backups');
                        backups.value = res.data;
                    } catch (e) {
                        console.error(e);
                    }
                };

                const loadLogs = async () => {
                    if(!isLoggedIn.value) return;
                    try {
                        const res = await axios.get('/api/logs');
                        logs.value = res.data.logs;
                    } catch (e) {}
                };

                const restore = async (name) => {
                    try {
                        await axios.post('/api/restore?file_name=' + name);
                        ElementPlus.ElMessage.warning('正在后台下载并还原，完成后服务将自动重启');
                        setTimeout(loadLogs, 2000);
                    } catch(e) {
                        ElementPlus.ElMessage.error('请求失败');
                    }
                };
                
                const handleUploadSuccess = () => {
                     ElementPlus.ElMessage.success('文件上传成功，正在解压还原...');
                     setTimeout(loadLogs, 2000);
                };
                
                const handleUploadError = () => {
                    ElementPlus.ElMessage.error('上传失败，请检查网络或权限');
                };

                onMounted(() => {
                    if (localStorage.getItem('vw_auth_token')) {
                        axios.get('/api/auth_check')
                            .then(() => {
                                isLoggedIn.value = true;
                                initData();
                            })
                            .catch(() => {
                                localStorage.removeItem('vw_auth_token');
                            });
                    }
                });

                return { 
                    isLoggedIn, loginForm, login, logout, loginLoading,
                    config, backups, logs, saveConfig, backupNow, restore, loading, loadBackups, 
                    handleUploadSuccess, handleUploadError, authHeaders, loadLogs, activeCollapse
                };
            }
        });
        
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component)
        }
        app.use(ElementPlus).mount('#app');
    </script>
</body>
</html>
