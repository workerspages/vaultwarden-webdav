<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaultwarden 管理面板</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <style>
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; margin: 0; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #101828 0%, #3b82f6 100%); }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="app">
        <!-- 登录界面 -->
        <div v-if="!isLoggedIn" class="login-container">
            <el-card class="w-96 glass shadow-2xl rounded-xl border-none">
                <template #header>
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-gray-800">系统登录</h2>
                        <p class="text-gray-500 text-sm mt-1">Vaultwarden Backup Admin</p>
                    </div>
                </template>
                <el-form label-position="top" size="large" @submit.prevent="login">
                    <el-form-item label="用户名">
                        <el-input v-model="loginForm.username" prefix-icon="User" placeholder="DASHBOARD_ADMIN_USER"></el-input>
                    </el-form-item>
                    <el-form-item label="密码">
                        <el-input v-model="loginForm.password" type="password" prefix-icon="Lock" show-password placeholder="DASHBOARD_ADMIN_PASSWORD"></el-input>
                    </el-form-item>
                    <el-button type="primary" class="w-full mt-4 font-bold" @click="login" :loading="loginLoading">登 录</el-button>
                </el-form>
            </el-card>
        </div>

        <!-- 主面板界面 (登录后显示) -->
        <div v-else class="container mx-auto p-6 max-w-5xl fade-in">
            <header class="flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white p-2 rounded-lg font-bold">VW</div>
                    <h1 class="text-2xl font-bold text-gray-800">Vaultwarden <span class="text-blue-600">Admin</span></h1>
                </div>
                <div class="flex items-center gap-4">
                    <el-tag type="success" effect="dark" round>Service Running</el-tag>
                    <el-button type="danger" plain size="small" @click="logout" icon="SwitchButton">退出</el-button>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                <!-- 左侧：操作与配置 (占7份) -->
                <div class="md:col-span-7 space-y-6">
                    <!-- 操作卡片 -->
                    <el-card class="glass shadow-lg rounded-xl">
                        <template #header><div class="font-bold flex items-center gap-2"><el-icon><Operation /></el-icon> 快捷操作</div></template>
                        <div class="flex flex-col gap-4">
                            <div class="flex gap-4">
                                <el-button type="primary" size="large" class="flex-1 h-12" @click="backupNow" :loading="loading" icon="UploadFilled">立即备份到云端</el-button>
                                <el-upload 
                                    class="flex-1"
                                    action="/api/upload_restore" 
                                    :headers="authHeaders" 
                                    :on-success="handleUploadSuccess" 
                                    :on-error="handleUploadError" 
                                    :show-file-list="false" 
                                    accept=".tar.gz,.enc">
                                    <el-button type="warning" size="large" class="w-full h-12" icon="RefreshLeft">上传文件还原</el-button>
                                </el-upload>
                            </div>
                        </div>
                    </el-card>

                    <!-- 配置卡片 -->
                    <el-card class="glass shadow-lg rounded-xl">
                        <template #header><div class="font-bold flex items-center gap-2"><el-icon><Setting /></el-icon> 系统配置</div></template>
                        <el-form label-position="top" size="default">
                            <el-form-item label="WebDAV 地址">
                                <el-input v-model="config.webdav_url" placeholder="https://dav.example.com/"></el-input>
                            </el-form-item>
                            <div class="grid grid-cols-2 gap-4">
                                <el-form-item label="WebDAV 用户名">
                                    <el-input v-model="config.webdav_user"></el-input>
                                </el-form-item>
                                <el-form-item label="WebDAV 密码">
                                    <el-input type="password" v-model="config.webdav_password" show-password></el-input>
                                </el-form-item>
                            </div>
                            
                            <el-divider content-position="left">策略设置</el-divider>
                            <div class="grid grid-cols-2 gap-4">
                                <el-form-item label="定时备份策略 (Cron 表达式)">
                                    <template #label>
                                        <span>Cron 表达式</span>
                                        <el-tooltip content="例如: '0 */5 * * *' 表示每5分钟一次，'0 3 * * *' 表示每天凌晨3点" placement="top">
                                            <el-icon class="ml-1"><QuestionFilled /></el-icon>
                                        </el-tooltip>
                                    </template>
                                    <el-input v-model="config.schedule_cron" placeholder="0 3 * * *"></el-input>
                                    <a href="https://crontab.guru/" target="_blank" class="text-xs text-blue-500 mt-1 block">Cron 表达式生成助手</a>
                                </el-form-item>
                                <el-form-item label="云端保留备份数量">
                                     <template #label>
                                        <span>最大保留数量</span>
                                        <el-tooltip content="云端只保留最新的N份备份，多余的将被自动删除" placement="top">
                                            <el-icon class="ml-1"><QuestionFilled /></el-icon>
                                        </el-tooltip>
                                    </template>
                                    <el-input-number v-model="config.max_backups" :min="1" :max="999" class="w-full"></el-input-number>
                                </el-form-item>
                            </div>

                            <el-divider content-position="left">高级设置</el-divider>
                            <el-form-item label="WebDAV 存储路径">
                                <el-input v-model="config.webdav_path" placeholder="/vaultwarden-backups"></el-input>
                            </el-form-item>
                            <el-form-item label="备份加密密码">
                                <el-input type="password" v-model="config.encryption_password" show-password placeholder="若设置，备份文件将被 AES 加密"></el-input>
                            </el-form-item>
                            
                            <el-divider content-position="left">通知 (Telegram)</el-divider>
                            <div class="grid grid-cols-2 gap-4">
                                <el-form-item label="Bot Token">
                                    <el-input v-model="config.tg_bot_token" placeholder="123456:ABC-DEF..."></el-input>
                                </el-form-item>
                                <el-form-item label="Chat ID">
                                    <el-input v-model="config.tg_chat_id" placeholder="-100xxxxxx"></el-input>
                                </el-form-item>
                            </div>
                            <el-button type="success" @click="saveConfig" class="w-full mt-2" icon="Check">保存所有配置</el-button>
                        </el-form>
                    </el-card>
                </div>

                <!-- 右侧：历史与日志 (占5份) -->
                <div class="md:col-span-5 space-y-6">
                    <!-- 历史备份 -->
                    <el-card class="glass shadow-lg rounded-xl" body-style="padding: 0px">
                        <template #header>
                            <div class="flex justify-between items-center">
                                <span class="font-bold flex items-center gap-2"><el-icon><List /></el-icon> 云端备份 ({{ backups.length }})</span>
                                <el-button size="small" @click="loadBackups" circle icon="Refresh"></el-button>
                            </div>
                        </template>
                        <div class="max-h-96 overflow-y-auto">
                            <el-table :data="backups" style="width: 100%" :show-header="false" empty-text="暂无数据">
                                <el-table-column min-width="180">
                                    <template #default="scope">
                                        <div class="flex flex-col">
                                            <span class="text-sm font-medium text-gray-700 truncate" :title="scope.row.name">{{ scope.row.name }}</span>
                                            <span class="text-xs text-gray-400">{{ scope.row.last_modified }}</span>
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column width="80" align="right">
                                    <template #default="scope">
                                        <span class="text-xs bg-gray-100 px-2 py-1 rounded">{{ scope.row.size }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column width="60" align="center">
                                    <template #default="scope">
                                        <el-popconfirm title="危险：确定还原此备份？服务将重启。" width="200" @confirm="restore(scope.row.name)">
                                            <template #reference>
                                                <el-button size="small" type="danger" circle icon="Download"></el-button>
                                            </template>
                                        </el-popconfirm>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </div>
                    </el-card>

                    <!-- 日志 -->
                    <el-card class="glass shadow-lg rounded-xl">
                        <template #header><div class="font-bold flex items-center gap-2"><el-icon><Document /></el-icon> 实时日志</div></template>
                        <pre class="bg-slate-900 text-green-400 p-4 rounded-lg text-xs h-64 overflow-y-auto font-mono leading-relaxed">{{ logs }}</pre>
                        <div class="mt-2 text-right">
                            <el-button size="small" link @click="loadLogs">刷新日志</el-button>
                        </div>
                    </el-card>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        const app = createApp({
            setup() {
                const isLoggedIn = ref(false);
                const loginLoading = ref(false);
                const loginForm = ref({ username: '', password: '' });
                // 默认配置
                const config = ref({ 
                    schedule_cron: '0 3 * * *', 
                    max_backups: 10,
                    webdav_path: '/' 
                });
                const backups = ref([]);
                const logs = ref('Waiting for logs...');
                const loading = ref(false);

                // 计算 Header
                const authHeaders = computed(() => {
                    const token = localStorage.getItem('vw_auth_token');
                    return token ? { 'Authorization': `Basic ${token}` } : {};
                });

                // Axios 拦截器
                axios.interceptors.request.use(cfg => {
                    const token = localStorage.getItem('vw_auth_token');
                    if (token) {
                        cfg.headers.Authorization = `Basic ${token}`;
                    }
                    return cfg;
                }, error => Promise.reject(error));

                axios.interceptors.response.use(res => res, err => {
                    if (err.response && err.response.status === 401) {
                        logout();
                        ElementPlus.ElMessage.error('登录已失效，请重新登录');
                    }
                    return Promise.reject(err);
                });

                const login = async () => {
                    if(!loginForm.value.username || !loginForm.value.password) return;
                    loginLoading.value = true;
                    const token = btoa(`${loginForm.value.username}:${loginForm.value.password}`);
                    localStorage.setItem('vw_auth_token', token);
                    
                    try {
                        await axios.get('/api/auth_check');
                        isLoggedIn.value = true;
                        ElementPlus.ElMessage.success('欢迎回来');
                        initData();
                    } catch (e) {
                        localStorage.removeItem('vw_auth_token');
                        ElementPlus.ElMessage.error('用户名或密码错误');
                    } finally {
                        loginLoading.value = false;
                    }
                };

                const logout = () => {
                    localStorage.removeItem('vw_auth_token');
                    isLoggedIn.value = false;
                    loginForm.value = { username: '', password: '' };
                };

                const initData = async () => {
                    await loadConfig();
                    loadLogs();
                    setInterval(loadLogs, 10000);
                };

                const loadConfig = async () => {
                    try {
                        const res = await axios.get('/api/config');
                        if(Object.keys(res.data).length > 0) {
                            config.value = { ...config.value, ...res.data };
                            // 如果旧配置没有这些字段，赋予默认值
                            if(!config.value.schedule_cron) config.value.schedule_cron = '0 3 * * *';
                            if(!config.value.max_backups) config.value.max_backups = 10;
                        }
                        if(config.value.webdav_url) loadBackups();
                    } catch(e) {}
                };

                const saveConfig = async () => {
                    try {
                        await axios.post('/api/config', config.value);
                        ElementPlus.ElMessage.success('配置保存成功，调度任务已更新');
                    } catch(e) {
                        ElementPlus.ElMessage.error('保存失败');
                    }
                };

                const backupNow = async () => {
                    loading.value = true;
                    try {
                        await axios.post('/api/backup/now');
                        ElementPlus.ElMessage.success('后台备份任务已启动');
                        setTimeout(loadLogs, 1000);
                    } catch(e) {
                        ElementPlus.ElMessage.error('触发失败');
                    } finally {
                        loading.value = false;
                    }
                };

                const loadBackups = async () => {
                    try {
                        const res = await axios.get('/api/backups');
                        backups.value = res.data;
                    } catch (e) {
                        console.error(e);
                    }
                };

                const loadLogs = async () => {
                    if(!isLoggedIn.value) return;
                    try {
                        const res = await axios.get('/api/logs');
                        logs.value = res.data.logs;
                    } catch (e) {}
                };

                const restore = async (name) => {
                    try {
                        await axios.post('/api/restore?file_name=' + name);
                        ElementPlus.ElMessage.warning('正在后台下载并还原，完成后服务将自动重启');
                        setTimeout(loadLogs, 2000);
                    } catch(e) {
                        ElementPlus.ElMessage.error('请求失败');
                    }
                };
                
                const handleUploadSuccess = () => {
                     ElementPlus.ElMessage.success('文件上传成功，正在解压还原...');
                     setTimeout(loadLogs, 2000);
                };
                
                const handleUploadError = () => {
                    ElementPlus.ElMessage.error('上传失败，请检查网络或权限');
                };

                onMounted(() => {
                    if (localStorage.getItem('vw_auth_token')) {
                        axios.get('/api/auth_check')
                            .then(() => {
                                isLoggedIn.value = true;
                                initData();
                            })
                            .catch(() => {
                                localStorage.removeItem('vw_auth_token');
                            });
                    }
                });

                return { 
                    isLoggedIn, loginForm, login, logout, loginLoading,
                    config, backups, logs, saveConfig, backupNow, restore, loading, loadBackups, 
                    handleUploadSuccess, handleUploadError, authHeaders, loadLogs
                };
            }
        });
        
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component)
        }
        app.use(ElementPlus).mount('#app');
    </script>
</body>
</html>
